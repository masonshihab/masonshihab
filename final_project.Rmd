---
title: "What Predicts a Country's COVID-19 Response?"
author: "Bingling Jason Mason Shi Shi Yixuan"
date: "5/2/2021"
output: 
    ioslides_presentation:
        css: style.css
        widescreen: yes
---

<style type="text/css">

body, td {
   font-size: 14px;
}
code.r{
  font-size: 12px;
}
pre {
  font-size: 4px
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(ggplot2)
library(pls)
library(caret)
library(rnaturalearth)
library(rnaturalearthdata)
library(rgeos)
library(RColorBrewer)
library(gtable)
library(gridExtra)
library(cowplot)
library(sjPlot)
```

```{r dataset, include=FALSE}
covid_cases <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv")
covid_cases %>%
  rowwise() %>%
  select(`Province/State`,`Country/Region`,`5/3/21`) %>%
  rename(total_region = `5/3/21`) %>%
  group_by(`Country/Region`) %>%
  mutate(total_cases = sum(total_region)) %>%
  distinct(`Country/Region`,total_cases) %>%
  rename(`Country_Region` = `Country/Region`)-> covid_cases1

covid_deaths <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
covid_deaths %>%
  rowwise() %>%
  select(`Province/State`,`Country/Region`,`5/3/21`) %>%
  rename(total_region = `5/3/21`) %>%
  group_by(`Country/Region`) %>%
  mutate(total_deaths = sum(total_region)) %>%
  distinct(`Country/Region`,total_deaths) %>%
  rename(`Country_Region` = `Country/Region`)-> covid_deaths1

covid_recovered <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv")
covid_recovered %>%
  rowwise() %>%
  select(`Province/State`,`Country/Region`,`5/3/21`) %>%
  rename(total_region = `5/3/21`) %>%
  group_by(`Country/Region`) %>%
  mutate(total_recovered = sum(total_region)) %>%
  distinct(`Country/Region`,total_recovered) %>%
  rename(`Country_Region` = `Country/Region`)-> covid_recovered1

country_code <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv")
na = is.na(country_code$Province_State)
country_code[na,] -> country_code1
country_code1 %>%
  select(-c(FIPS,Admin2,Province_State)) -> country_code1

covid_cases1 %>%
  left_join (country_code1, by = "Country_Region") %>%
  left_join(covid_deaths1, by = "Country_Region") %>%
  left_join(covid_recovered1, by = "Country_Region") %>%
  rename(Long = Long_) %>%
  select(-Combined_Key) %>%
  relocate(Country_Region,total_cases,total_deaths, total_recovered, Population) -> total_cases

culture = read_xls("cultural_orientation.xls")
culture1 = culture[-c(1,2,6,15,16,22,41,92,97,98,102),-1]
total_cases %>% 
  left_join(culture1, by = c("Country_Region" = "country")) -> covid1

WVS <- read_csv("JHU_WVS2.csv") %>% 
  select("Country_Region","freedom":"gov_confidence")
covid1 %>% left_join(WVS, by = "Country_Region") -> covid2

gini_index <- read_csv("cleaned GINI INDEX.csv")
covid2 %>% 
  left_join(gini_index, by = c("Country_Region" = "Country_Name")) -> covid3

health_investment <- read_csv("health_investment.csv")
covid3 %>% 
  left_join(health_investment, by = c("Country_Region" = "country")) -> covid4

covid4 %>%
  mutate(deaths_over_pop = total_deaths/Population,
         affection_rate = total_cases/Population) -> covid4

cancel_events <- read_csv("public-events-covid.csv")
cancel_events %>%
  group_by(Entity) %>%
  filter(cancel_public_events == max(cancel_public_events)) %>%
  mutate(cancel_events_level = as.factor(cancel_public_events)) %>%
  ungroup() %>%
  distinct (Code, cancel_events_level) -> cancel_events1
covid4 %>%
  left_join(cancel_events1, by = c("iso3" = "Code")) -> covid4

international_travel <- read_csv("international-travel-covid.csv")
international_travel %>%
  group_by(Entity) %>%
  filter(international_travel_controls == max(international_travel_controls)) %>%
  mutate(international_control_level = as.factor(international_travel_controls)) %>%
  ungroup()%>%
  distinct(Code, international_control_level) -> international_travel1
covid4 %>%
  left_join(international_travel1, by = c("iso3" = "Code")) -> covid4

internal_movement <- read_csv("internal-movement-covid.csv")
internal_movement %>%
  group_by(Entity) %>%
  filter(restrictions_internal_movements == max(restrictions_internal_movements)) %>%
  mutate(internal_control_level = as.factor(max(restrictions_internal_movements))) %>%
  ungroup()  %>%
  distinct(Code, internal_control_level)-> internal_movement1
covid4 %>%
  left_join(internal_movement1, by = c("iso3" = "Code")) -> covid4

face_covering <- read_csv("face-covering-policies-covid.csv")
face_covering %>%
  group_by(Entity) %>%
  filter(facial_coverings == max(facial_coverings))%>%
  mutate(facial_cover_level = as.factor(max(facial_coverings))) %>%
  ungroup() %>%
  distinct(Code,facial_cover_level) -> face_covering1
covid4 %>%
  left_join(face_covering1, by = c("iso3" = "Code")) -> covid4
```

## Covid-19: One Year in a Nutshell

- One year into the global pandemic, the infection rate and death rate differ drastically between countries.

```{r, include=FALSE}
# load world data
world <- ne_countries(scale = "medium", returnclass = "sf")
# combine the covid data and world data
map_data <- world %>% left_join(covid4, by = c("iso_a2" = "iso2"))
```

```{r, include=FALSE}
affectionrate_map <- ggplot() +
  geom_sf(data = map_data, aes(fill = affection_rate)) +
  scale_fill_gradient(low = "bisque", high = "maroon3") +
  labs(fill = "Infection Rate", title="Infection Rate by Country") +
  theme_classic()
deathrate_map <- ggplot() +
  geom_sf(data = map_data, aes(fill = deaths_over_pop)) +
  scale_fill_gradient(low = "bisque", high = "maroon3") +
  labs(fill = "Death Rate", title="Death Rate by Country")+
  theme_classic()
```
```{r, echo=FALSE, fig.align='center'}
gridExtra::grid.arrange(affectionrate_map,
                        deathrate_map,
                        nrow=2,
                        layout_matrix=rbind(c(1,1),c(2,2)))
```



## Covid-19: One Year in a Nutshell

- Countries around the world have also responded to COVID-19 very differently.

```{r, include=FALSE}
palette = colorRampPalette(brewer.pal(n=6, name='YlOrRd'))(6)
#palette = c("bisque", palette)
map_data$facial_cover_level <- factor(map_data$facial_cover_level,
                                      levels = c(NA,"0","1","2","3","4"))
face_covering_map <- ggplot() +
  geom_sf(data = map_data, aes(fill = facial_cover_level)) +
  scale_fill_manual(values = palette) +
  labs(fill = "Facial Cover Levels", title="Facial Cover Levels") +
  theme_classic()

palette = colorRampPalette(brewer.pal(n=5, name='YlOrRd'))(4)
#palette = c("bisque", palette)
map_data$international_control_level <- factor(map_data$international_control_level, 
                                               levels = c(NA,"2","3","4"))
international_travel_map <- ggplot() +
  geom_sf(data = map_data, aes(fill = international_control_level)) +
  scale_fill_manual(values = palette) +
  labs(fill = "International Travel Control Levels", title="International Travel Policy") +
  theme_classic()
```
```{r, echo=FALSE,, fig.align='center'}
gridExtra::grid.arrange(face_covering_map,
                        international_travel_map,
                        nrow=2,
                        layout_matrix=rbind(c(1,1),c(2,2)))
```


## Why?

- What characteristics can make a country more effective at combating a pandemic?

- In this study, we attempted to look at this question from four perspectives: **physical/mental wellness**, **social/political development**,**personal independence**, and **government mitigation orders**.

- The data that we explored included: Cultural Orientation, World Values Survey, Gini Index, Health Investments, Oxford COVID-19 Government Response Tracker

## Hypotheses

<font size="4">
H1a: Variables measuring greater (physical or mental) wellness will predict lower death rates.<br>H1b: Variables measuring greater (physical or mental) wellness will predict lower infection rates.<br><br>H2a: Variables measuring greater social/political development will predict lower death rates.<br>H2b: Variables measuring greater social/political development will predict lower infection rates.<br><br>H3a: Variables measuring greater personal independence will predict greater death rates.<br>H3b: Variables measuring greater personal independence will predict greater infection rates.<br><br>H4a: Variables measuring government mitigation orders will predict lower death rates.<br>H4b: Variables measuring government mitigation orders will predict lower infection rates.
</font>


## Methods Step 1: Variable Selection

- We merged the datasets and used stepwise regressions to select the best model for each DV.

- We decided to use variables suggested by the backward regressions for both DVs since the MSE of the backward regression was smaller for both DVs. 

```{r, include=FALSE}
# for death rate only
covid4 %>%
  ungroup() %>%
  select(-c('Country_Region',
         'total_cases',
         'total_recovered',
         'UID', 
         "X1",
         'iso2', 
         'iso3', 
         'code3', 
         'Lat', 
         'Long', 
         'Population', 
         'total_deaths',
         'cancel_events_level')) %>%
  select(-affection_rate) %>%
  drop_na() %>%
  relocate(deaths_over_pop) -> covid5
# for affection rate only
covid4 %>%
  ungroup() %>%
  select(-c('Country_Region',
         'total_cases',
         'total_recovered',
         'UID', 
         "X1",
         'iso2', 
         'iso3', 
         'code3', 
         'Lat', 
         'Long', 
         'Population', 
         'total_deaths',
         'cancel_events_level')) %>%
  select(-deaths_over_pop) %>%
  drop_na() %>%
  relocate(affection_rate) -> covid6
# define intercept-only model
intercept_only_death <- lm(deaths_over_pop ~ 1, data = covid5)
intercept_only_affection <- lm(affection_rate ~ 1, data = covid6)
# define model with all predictors
all_death <- lm(deaths_over_pop ~., data = covid5)
all_affection <- lm(affection_rate ~ ., data = covid6)
theme_sjplot(base_size = 4, base_family = "")
```

## Selected Variables by Relevant Hypotheses

<font size="4"><ol>
   <li>Variables related to H1a and H1b: Wellness
            <ul>
               <li>Perceived state of health (health)</li>
               <li>Avoidance of uncertainty (uai)</li>
            </ul>
   <li>Variables related to H2a and H2b: Social/Political Development
               <ul>
               <li>Satisfaction with Political System (Pol_Stais)</li>
               <li>Confidence in Government (Gov_confidence)</li>
            </ul>
   <li>Variables related to H3a and H3b: Personal Independence
               <ul>
               <li>Individuality over collectivism (idv)</li>
               <li>Perceived personal freedom (freedom)</li>
            </ul>
   <li>Variables related to H4a and H4b: Government Mitigation Orders
               <ul>
               <li>Total border closure (international_control_level4)</li>
               <li>Recommendation--but not mandate--to restrict domestic travel (internal_control_level1)</li>
               <li>Order to wear mask when distancing not possible (facial_cover_level2)</li>
               <li>Universal masking order (facial_cover_level4)</li>
            </ul>
</ol></font>


## Selecting variables for Death Rate {.codefont2}

```{r, echo=FALSE}
# perform backward stepwise regression
backward <- step(all_death, direction = 'backward', scope = formula(all_death), trace = 0)
# view results of backward stepwise regression
model1 = tab_model(backward, pred.labels = c("Intercept", "Individualism", "Uncertainty Avoidance", "Freedom", "Political System Satisfaction", "Health", "Total Border Closure"), dv.labels = "Death Rate")
model1

```

## Selecting variables for Infection Rate {.codefont2}

```{r, echo=FALSE}
# perform backward stepwise regression
backward <- step(all_affection, direction = 'backward', scope = formula(all_affection), trace = 0)
# view results of backward stepwise regression
tab_model(backward, pred.labels = c("Intercept", "Individualism", "Masculinity", "Uncertainty Avoidance", "Freedom", "Political System Satisfaction", "Competitiveness", "Government Confidence", "Total Border Closure", "Movement Restriction","Mask Level 4", "Mask Level 2" ), dv.labels = "Infection Rate")
```


## Methods Step 2: Running Regressions

We started with a simple OLS linear regression model. To test for additional robustness due to the small sample size (only had full data for 39 countries), we then performed additional complex analyses: 

1) 10-segment cross validation to measure predictive strength of patterns in our data; 
2) Partial least squares analysis to identify explanatory components; and 
3) Jackknife regression to see if prior linear regression results were still found with estimated datapoints.

## Death Rate Results: the OLS Regression {.codefont2}

```{r, include=FALSE}
# original DV
model1_death <- lm(deaths_over_pop ~ idv+uai+freedom+pol_satis+health+international_control_level, 
                   data=covid5)
```

<div id="row1">

<div class="column-left">
<font size="3"><br>
***H1a: Variables measuring greater (physical or mental) wellness will predict lower death rates.***: Weakly Supported

***H2a: Variables measuring greater social/political development will predict lower death rates.***: Supported

***H3a: Variables measuring greater personal independence will predict greater death rates.***: Supported

***H4a: Variables measuring government mitigation orders will predict lower death rates.***: Supported
</font>
</div>

<div class="column-right">
```{r, echo=FALSE}
tab_model(model1_death, pred.labels = c("Intercept", "Individualism", "Uncertainty Avoidance", "Freedom", "Politial System Satisfaction", "Health", "Border Closure"), dv.labels = "Death Rate") 
```

</div>
</div>


## Infection Rate Results: the OLS Regression {.codefont2}



```{r, include=FALSE}
# original DV
model1_affection <- lm(affection_rate ~ idv+mas+uai+freedom+pol_satis+
                         competitiveness+gov_confidence+
                         international_control_level+internal_control_level+facial_cover_level,
                       data=covid6)

summary(model1_affection)
 
```


<div id="row1">
<div class="column-left">
<font size="3"><br>

***H1b: Variables measuring greater (physical or mental) wellness will predict lower case rates.***: Weakly Supported

***H2b: Variables measuring greater social/political development will predict lower case rates.***: Supported

***H3b: Variables measuring greater personal independence will predict greater case rates.***: Supported

***H4b: Variables measuring government mitigation orders will predict lower case rates.***: Supported

</font>
</div>

<div class="column-right">
```{r, echo=FALSE}
tab_model(model1_affection, pred.labels =  c("Intercept", "Individualism", "Masculinity", "Uncertainty Avoidance", "Freedom", "Political System Satisfaction", "Competitiveness", "Government Confidence", "Border Closure", "Movement Restriction", "Masl Level 4", "Mask Level 2"), dv.labels = "Infection Rate")
```
</div>
</div>

## Interesting Findings

- Satisfaction with Political System (0-10)
- This variable was found to significantly explain both of the DVs.

```{r, include=FALSE}
pol_satis_map <- ggplot() +
  geom_sf(data = map_data, aes(fill = pol_satis)) +
  scale_fill_gradient(low = "bisque", high = "deeppink") +
  labs(fill = "Satisfaction with Political System", title="Satisfaction with Political System") +
  theme_classic()
```
```{r, echo=FALSE, fig.align='center'}
grid.arrange(pol_satis_map,affectionrate_map,deathrate_map, nrow=2,
             layout_matrix = rbind(c(1,1),c(2,3)))
```


## Interesting Findings

- Face Covering Policy (0-4)
- This variable was found to significantly explain **Infection Rate** only.

```{r, echo=FALSE, fig.align='center'}
gridExtra::grid.arrange(face_covering_map,
                        affectionrate_map,
                        nrow=2,
                        layout_matrix=rbind(c(1,1),c(2,2)))
```

## Interesting Findings

- Perceived Personal Freedom (0-10)
- This variable was found to significantly explain **Death Rate** only.

```{r, include=FALSE}
freedom_map <- ggplot() +
  geom_sf(data = map_data, aes(fill = freedom)) +
  scale_fill_gradient(low = "bisque", high = "blue3") +
  labs(fill = "Perceived Personal Freedom", title = "Perceived Personal Freedom")+
  theme_classic()
```
```{r, echo=FALSE, fig.align='center'}

gridExtra::grid.arrange(freedom_map,
                        deathrate_map,
                        nrow=2,
                        layout_matrix=rbind(c(1,1),c(2,2)))
```

## Discussion
- Limitation: small sample size

- International control level predicts lower death rates 

- International control level and internal control level predict lower infection rates 
 
- Greater personal independence predicts greater death rates and infection rates

- Greater political system satisfaction predicts lower death rates and infection rates
 
## Attribution

Every team member attended meetings, found datasets, and brainstormed ideas. Shi Shi did the backward and forward regressions to select the variables. Bingling and Mason ran the OLS regressions, cross-validation LM regressions, and PLS and Jackknife tests. Yixuan made the beautiful maps. Last but not least, Jason made the slides for our presentation. 